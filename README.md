# 最長片道切符問題ソルバ
最長片道切符問題のソルバです。
詳細は[最長片道切符の流儀とバリエーション](https://nue2004.info/railway/lop/)をご覧ください。


## 構成
本リポジトリは以下のファイル/ディレクトリから構成されています。
* `solve.py` : 最長片道切符問題ソルバ本体
* `make.bat` : ビルドスクリプト（Windows バッチファイル）
* `make.sh` : ビルドスクリプト（Bash スクリプト）
* `input` : 入力ファイルを格納しておくディレクトリ
	* `input/*.tsv` : 入力ファイルのサンプル
* `output` : 出力ファイルが格納されるディレクトリ
* `log` : 整数計画問題ソルバのログが格納されるディレクトリ
* `README.md` : 本書


## 前提
最長片道切符問題ソルバは、以下がインストールされていることを実行の前提としています。
* Python 3
	* 本書及びビルドスクリプトは、コマンド `python` で Python 3 が実行されることを前提としています。環境に応じて `python` を `python3` に読み替えて（書き替えて）ください。
* PuLP
* お好みの整数計画問題ソルバ
	* 特にこだわりが無ければ PuLP に附属している CBC MILP Solver で構いません。
	* 整数計画問題ソルバに依っては結果がなかなか返ってこないことがあります。その場合は別のソルバを使ってみてください。
		* どういう訳か Linux 版 CBC 2.10.3 では上手くいくのに Windows 版 CBC 2.10.3 では駄目でした。
	* フリーの整数計画問題ソルバとしては動作が高速な [SCIP](https://www.scipopt.org/) がオススメです。

以下の環境で動作確認済です。
* Windows 10 Pro (64bit) + Python 3.12.2 + PuLP 2.8.0 + CBC MILP Solver 2.10.11
* Windows 10 Pro (64bit) + Python 3.12.2 + PuLP 2.8.0 + SCIP 8.1.0
* Ubuntu 22.04 LTS (64bit) + Python 3.10.12 + PuLP 2.7.0 + CBC MILP Solver 2.10.7
* Ubuntu 22.04 LTS (64bit) + Python 3.10.12 + PuLP 2.7.0 + SCIP 8.0.3


## 実行
### 使ってみる
Windows の場合は `make.bat` を、Unix 系の場合は `make.sh` を実行してください。

各入力ファイル <code>input/*basename*.tsv</code> に対し、以下3つのファイルがディレクトリ `output` に出力されます。  
また、それぞれに対応する整数計画問題ソルバのログがディレクトリ `log` に出力されます。
* <code>output/*basename*_dist0.dat</code> : 路線網 <code>input/*basename*.tsv</code> における営業キロ派の最長路
* <code>output/*basename*_dist1.dat</code> : 路線網 <code>input/*basename*.tsv</code> における運賃計算キロ派の最長路
* <code>output/*basename*_dist2.dat</code> : 路線網 <code>input/*basename*.tsv</code> における実乗可能粁程派の最長路

求解の過程で、途中経過が標準エラー出力に出力されます。


### `solve.py` の説明
最長片道切符問題ソルバ `solve.py` の基本動作は以下の通りです。
<pre><code>$ python solve.py &lt; <i>input</i> &gt; <i>output</i></code></pre>
* 標準入力 *`input`* から入力（路線網）を読み込む
* 標準出力 *`output`* に出力（最長路）を書き出す
* 標準エラー出力に求解の途中経過を書き出す
* ログファイル `pulp.log` に整数計画問題ソルバのログを書き出す

オプションを特に指定しない場合、入力した路線網における営業キロ派の最長路を出力します。  
これはオプション `-0`（営業キロ派）、`-1`（運賃計算キロ派）、`-2`（実乗可能粁程派）によって変更できます。
<pre><code>$ python solve.py -0 &lt; <i>input</i> &gt; <i>output</i>    # 営業キロ派の最長路（既定）
$ python solve.py -1 &lt; <i>input</i> &gt; <i>output</i>    # 運賃計算キロ派の最長路
$ python solve.py -2 &lt; <i>input</i> &gt; <i>output</i>    # 実乗可能粁程派の最長路</code></pre>

整数計画問題ソルバのログの出力先はオプション `-l` で変更できます。
<pre><code>$ python solve.py -l <i>logfile</i> &lt; <i>input</i> &gt; <i>output</i>    # ログの出力先を pulp.log に代えて <i>logfile</i> にする</code></pre>

整数計画問題ソルバの使用するスレッド数の最大値はオプション `-t` で指定できます。  
（但し、大きな値を指定したからと言って速くなるとは限りません）
<pre><code>$ python solve.py -t 4 &lt; <i>input</i> &gt; <i>output</i>    # 整数計画問題ソルバの使用するスレッド数の最大値を 4 にする</code></pre>


### 整数計画問題ソルバの変更
`solve.py` の第95行附近に以下の記述があります。
```Python
# 整数計画問題ソルバ (使いたいソルバに応じて書き換える)
solver = pulp.PULP_CBC_CMD(msg=False, threads=args.threads, gapRel=0, gapAbs=0, warmStart=False, logPath=args.logfile)
#solver = pulp.COIN_CMD(msg=False, threads=args.threads, gapRel=0, gapAbs=0, warmStart=False, logPath=args.logfile)
#solver = pulp.SCIP_CMD(msg=False, options=['-c', 'set numerics feastol 1e-10', '-c', 'set parallel maxnthreads {0}'.format(args.threads), '-l', args.logfile])
```
初期状態では整数計画問題ソルバとして PuLP 附属の CBC MILP Solver (`PULP_CBC_CMD`) を使用するようになっています。  
個別にインストールした CBC MILP Solver を使用したい場合は `COIN_CMD` の行を、SCIP を使用したい場合は `SCIP_CMD` の行を、`PULP_CBC_CMD` の行に代えてアンコメントしてください。  
（使用したいソルバがインストール済であり、パスが通っていることが前提です）

これら以外の整数計画問題ソルバも、PuLP から呼び出せるものであれば何でも使用できます。  
具体的な設定方法は各整数計画問題ソルバ及び PuLP のドキュメントを参照してください。


## 入力の形式
[最長片道切符問題の定式化](https://nue2004.info/railway/lop/modeling.htm)に記した通り、最長片道切符問題の求解にあたり、路線網をグラフ（重み付き無向多重グラフ）と見做します。

最長片道切符問題ソルバ `solve.py` の入力は、路線網（グラフ）の枝集合とします。枝集合は以下の形式で表現します。  
（孤立点は存在しないものとし、枝の両端点全体を以て頂点集合とします。名称を同じくする頂点は同一の頂点とします。）
* 枝集合は、文字符号化形式 UTF-8 で記述された0個以上の行からなるプレーンテキストによって表現する。
* 各行において、行内に番号記号 `#` (U+0023) が存在する場合、番号記号を含めてそれ以降行末までの文字列を**コメント**と呼ぶ。
	* 番号記号は専らコメントの開始として扱われる。番号記号をエスケープすることはできない。
* コメントを除いた部分が0個以上の空白文字のみからなる行を**空行**と呼ぶ。空行は無視する。
* 空行以外の行において、コメントを除いた部分を**枝定義**と呼ぶ。
* 各枝定義は、路線網における1本の枝を定義する。
* 各枝定義は、タブ文字 (U+0009) を区切りとする7個以上のフィールドからなる。各フィールドの内容は以下の通り。
	* 第0フィールド : 枝（に対応する線区）の事業者名
	* 第1フィールド : 枝（に対応する線区）の線名
	* 第2フィールド : 枝の一端点たる頂点（駅）の名称
	* 第3フィールド : 枝の他端点たる頂点（駅）の名称
	* 第4フィールド : 枝の営業粨程[^1]（整数値）
	* 第5フィールド : 枝の運賃計算粨程（整数値）
	* 第6フィールド : 枝の実乗可能粨程（整数値）
	* 第7フィールド（省略可） : 枝に関する追加の制約条件（次項参照）
	* 第8フィールド以降は無視する

[^1]: 「粨程」は粁程の数値の10倍の値（粁程と同じ長さを単位ヘクトメートル hm で表した数値）


### 枝に関する追加の制約条件
経路特定区間等の制約条件を表現するため、「選言制約」「排他制約」という2種類の制約を記述できるようにしています。  
制約条件は、枝定義の第7フィールドにカンマ `,` (U+002C) を区切りとして任意個指定できます。

#### 選言制約
制約条件として <code>+_group_</code>, <code>-_group_</code>（但し _`group`_ は共通の文字列）を指定した枝に対し、次の制約を加えます。
> 以下のいずれかが成り立つ。
> * <code>+_group_</code> を附した枝のうち少なくとも1本は最長路に含まれる
> * <code>-_group_</code> を附した枝のうち少なくとも1本は最長路に含まれない

これは以下の不等式制約に対応します。（不等式や変数については[最長片道切符問題の定式化](https://nue2004.info/railway/lop/modeling.htm)を参照）
```math
\sum_{\substack{\text{edge $i$ with}\\\text{\texttt{+}\textit{group}}}} \bar{x}_i + \sum_{\substack{\text{edge $i$ with}\\\text{\texttt{-}\textit{group}}}} (1 - \bar{x}_i) \ge 1
```

#### 排他制約
制約条件として <code>*_group_</code>, <code>:_group_</code>（但し _`group`_ は共通の文字列）を指定した枝に対し、次の制約を加えます。
> 以下が共に成り立つ。
> * <code>*_group_</code> を附した枝のうち最長路に含まれる枝は高々1本だけである
> * <code>*_group_</code> を附した枝が1本でも最長路に含まれるならば、<code>:_group_</code> を附した枝は1本も最長路に含まれない

これは以下の不等式制約に対応します。（但し $M$ は十分大きな定数; 不等式や変数については[最長片道切符問題の定式化](https://nue2004.info/railway/lop/modeling.htm)を参照）
```math
\sum_{\substack{\text{edge $i$ with}\\\text{\texttt{*}\textit{group}}}} M \bar{x}_i + \sum_{\substack{\text{edge $i$ with}\\\text{\texttt{:}\textit{group}}}} \bar{x}_i \le M
```


## 出力の形式
最長片道切符問題ソルバ `solve.py` の出力は、入力された路線網における最長路です。  
以下のように一端点から最長路に沿って経由する枝を順に出力します。
```
JR九州	大村線	竹松	早岐	328	361	328
JR九州	佐世保線	早岐	武雄温泉	262	262	262
JR九州	西九州新幹線	武雄温泉	新大村	322	322	322
JR九州	大村線	新大村	諫早	139	153	139
JR九州	長崎本線	諫早	江北	608	608	608
JR九州	長崎本線	江北	久保田	82	82	146
〔以下略〕
```
出力は、各枝について以下の内容をタブ文字 (U+0009) を区切りして出力します。
* 第0フィールド : 枝（に対応する線区）の事業者名
* 第1フィールド : 枝（に対応する線区）の線名
* 第2フィールド : 枝の頂点（駅）のうち最長路の起点側のものの名称
* 第3フィールド : 枝の頂点（駅）のうち最長路の終点側のものの名称
* 第4フィールド : 枝の営業粨程（整数値）
* 第5フィールド : 枝の運賃計算粨程（整数値）
* 第6フィールド : 枝の実乗可能粨程（整数値）


## 注意事項
### 入力ファイル `input/*.tsv` について
* 2024年4月1日時点の路線網及び各種規則に基づく入力ファイルです。
* 「北海道」「本州」「四国」「九州」のエリア毎に分割されています。（分割点は新青森・茶屋町・小倉）
	* 理論上は全国を単一の路線網として求解することもできますが、実際にはそのようにするとソルバが局所最適解を延々と計算し続けてしまって求解が終わらなくなるため、分割しています。
	* エリアを分割しているため、「本州と四国の私鉄の通過連絡運輸を高々1回だけ認める」といった制約を課すことはできません。
* 路線網から大村線竹松～新大村間は取り除いてあります。必要に応じて追加してください。
	* 大村線竹松～新大村間を除いた状態で得られた最長路の起終点が稚内～竹松であった場合、求解し直さずとも真の最長路は稚内～新大村であると言えます。
* 路線網及び制約条件は、[JR鉄道派](https://nue2004.info/railway/lop/points.htm#point2)・[尾久問題肯定派](https://nue2004.info/railway/lop/points.htm#point3)・[田端問題肯定派](https://nue2004.info/railway/lop/points.htm#pointx)・[新在同一派](https://nue2004.info/railway/lop/points.htm#point4)の最長路を求めるように記述しています。
	* 幾つかの枝定義をコメントアウト/アンコメントすれば他の流儀の最長路を求めることができるように記述しています。詳細は入力ファイル内のコメントをご確認ください。
* 制約条件のうち `+規69_` または `-規69_` で始まるものは、[JR旅客営業規則第69条](https://www.jreast.co.jp/ryokaku/02_hen/03_syo/01_setsu/03.html#69)（経路特定区間）によるものです。実乗可能粁程最長路の求解の際には、これらは不要な制約ですので取り除く必要があります。
	* ビルドスクリプトを使用する場合は、ビルドスクリプト内で取り除くようになっています。


### 求解・出力について
* 最長片道切符問題ソルバ `solve.py` は、片道乗車券の発売条件を満たす経路の他、片道乗車券の発売条件を満たさない[「タイプB」](https://nue2004.info/railway/lop/modeling.htm#cstrts_types)の経路を許容しています。求解の結果もし「タイプB」の経路が出力された場合、その起終点附近の1区間を除いた経路が最長路となるか改めて確認する必要があります。
* 最長片道切符問題ソルバ `solve.py` は、自己閉路（両端点が同一の頂点である枝）を許容していません。枝定義に自己閉路が存在する場合、エラーとなります。
* 最長路が複数存在する場合、そのうちのいずれの経路が出力されるかは整数計画問題ソルバ次第です。


### その他の注意事項
* 本リポジトリのプログラム及び関連するドキュメントの著作権は、作者である鵺に帰属します。
* 本リポジトリの最長片道切符問題ソルバが正しく最長路を出力することや、その経路の乗車券が発券可能であることは、作者は一切保証しません。
* 本リポジトリの利用に因り生じた如何なる損害に対しても、作者は一切の責任を負いかねます。

